var fs, generate, readPosts, getPartials, getPageCollections;

fs = require( 'fs' );
readPosts = require( 'readPosts' );
getPartials = require( 'getPartials' );
getPageCollections = require( 'getPageCollections' );


generate = function ( subtask, grunt ) {
	var files, i, data, partials, pageCollections, pageCollection, page;

	files = grunt.file.expand( subtask.src );
	data = readPosts( files );

	// first, render partials
	partials = getPartials( subtask.partials, data );

	
	// then, get pages
	pageCollections = getPageCollections( subtask.pages, data, partials );

	// then save pages
	i = pageCollections.length;
	while ( i-- ) {
		pageCollection = pageCollections[i];
		j = pageCollection.length;

		while ( j-- ) {
			page = pageCollection[j];

			console.log( page.path, page.data.substr( 0, 100 ) + '...' );

			fs.writeFileSync( page.path, page.data );
		}
	}
};

module.exports = generate;