/*jslint white: true */
/*global module, require */

module.exports = function ( grunt ) {

	'use strict';

	var path;

	path = require( 'path' );

	grunt.registerMultiTask( 'parse', 'Parse markdown content into JSON', function () {
		var config, files, parser, data, cwd, destFile, srcFiles, result;

		// ugh, this is fucked up
		if ( this.files.length !== 1 ) {
			grunt.log.error( 'One destination file per target please. Thanks' );
			return false;
		}

		config = this.data;

		cwd = config.cwd;

		destFile = this.files[0].dest;
		srcFiles = grunt.file.expand( this.filesSrc );

		console.log( srcFiles );


		result = [];

		srcFiles.forEach( function ( filepath ) {
			var relPath, data;

			relPath = path.relative( cwd, filepath );
			data = grunt.file.read( filepath );

			console.log( '\n\nparsing %s', relPath );

			result[ result.length ] = config.parser( data, relPath );

			console.log( 'parsed %s', relPath, '\n\n' );
		});

		data = JSON.stringify( result, null, '\t' );

		grunt.file.write( destFile, data );


	});

};