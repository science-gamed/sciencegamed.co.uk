/*global require, module */
/*jslint white: true */

var parse, metadataPattern, months, path, parseMarkdown, readDate, fs;

path = require( 'path' );
parseMarkdown = require( 'node-markdown' ).Markdown;
readDate = require( 'utils/readDate' );
fs = require( 'fs' );

metadataPattern = /^```([^`]+)```/;

readPost = function ( filename ) {
	
	'use strict';

	var post, metadata, match, markdown, html, pathParts, id, i, index, key, value, data;

	data = fs.readFileSync( filename ).toString();

	pathParts = filename.split( path.sep );
	id = pathParts[ pathParts.length - 1 ].replace( '.md', '' );

	post = { id: id };

	// read metadata
	match = metadataPattern.exec( data );

	if ( !match ) {
		throw 'Bad metadata for file "' + filename + '" - regex did not match';
	}

	metadata = match[1].split( '\n' );

	i = metadata.length;
	while ( i-- ) {
		index = metadata[i].indexOf( ':' );
		
		if ( index === -1 ) {
			continue;
		}
		
		key = metadata[i].substr( 0, index ).trim();
		value = metadata[i].substring( index + 1 ).trim();

		// date is a special case
		if ( key === 'date' ) {
			value = readDate( value );
		}

		post[ key ] = value;
	}

	markdown = data.substring( match[0].length ).trim();
	html = parseMarkdown( markdown );

	post.content = html;

	return post;
};


module.exports = readPost;