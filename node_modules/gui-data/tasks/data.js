module.exports = function ( grunt ) {
	
	grunt.registerTask( 'data', 'Concatenate data files', function () {
		var config, root, path, isDir, result, runTask;

		// fail if no 'data' option set
		grunt.config.requires( 'data' );

		path = require( 'path' );

		config = grunt.config( 'data' );
		root = config.root;
		result = {};

		isDir = /\/$/;

		runTask = function ( task ) {
			var subtask;

			if ( !task.root || !task.dest ) {
				for ( subtask in task ) {
					runTask( task[ subtask ] );
				}
				return;
			}

			grunt.file.recurse( task.root, function ( abs, root, subdir, filename ) {
				var dirs, obj, name, contents;

				console.log( abs, root, subdir, filename );

				contents = grunt.file.read( abs );

				try {
					contents = JSON.parse( contents );
					console.log( 'Storing %s as JSON', filename );
				} catch ( err ) {
					console.log( 'Storing %s as plain text', filename );
				}

				dirs = subdir ? subdir.split( path.sep ) : [];
				obj = result;

				while ( dirs.length ) {
					next = dirs.shift();

					if ( !obj[ next ] ) {
						obj[ next ] = {};
					}

					obj = obj[ next ];
				}

				name = filename.substr( 0, filename.length - path.extname( filename ).length );

				if ( name !== '.DS_Store' ) {
					obj[ name ] = contents;
				}
			});

			grunt.file.write( task.dest, JSON.stringify( result ) );
		};

		runTask( config );

		
	});
};